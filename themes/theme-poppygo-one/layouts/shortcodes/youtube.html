{{- $pc := .Page.Param "privacy_config" | default .Site.Params.privacy_config }}
{{- $cdn := false }}
{{- if (and ($pc) ($pc.youtube)) }}
    {{- $cdn = $pc.youtube.cdn | default false }}
{{- end }}

{{- $id := .Get "id" }}
{{- if not $id }}
  {{- errorf "youtube shortcode: missing id parameter for %q" .Inner }}
{{- end }}

{{- $class := .Get "class" }}
{{- $title := .Get "title" | default (printf "YouTube video: %s" $id) }}

{{/* New variables for additional arguments */}}
{{- $allowFullScreen := .Get "allowFullScreen" | default true }}
{{- $autoplay := .Get "autoplay" | default false }}
{{- $controls := .Get "controls" | default true }}
{{- $end := .Get "end" }}
{{- $loading := .Get "loading" | default "eager" }}
{{- $loop := .Get "loop" | default false }}
{{- $mute := .Get "mute" | default false }}
{{- $start := .Get "start" }}

{{/* Construct the YouTube URL with parameters */}}
{{- $youtubeURL := printf "https://www.youtube-nocookie.com/embed/%s" $id }}

{{/* --- MODIFIED LOGIC FOR QUERY STRING --- */}}
{{- $queryParams := slice }}
{{- if $autoplay }}
    {{ $queryParams = $queryParams | append "autoplay=1" }}
    {{ $queryParams = $queryParams | append "mute=1" }} {{/* autoplay forces mute=true */}}
{{- else if $mute }}
    {{ $queryParams = $queryParams | append "mute=1" }}
{{- end }}
{{- if not $controls }} {{/* only add if controls are disabled */}}
    {{ $queryParams = $queryParams | append "controls=0" }}
{{- end }}
{{- if $end }}
    {{ $queryParams = $queryParams | append (printf "end=%d" $end) }}
{{- end }}
{{- if $loop }}
    {{ $queryParams = $queryParams | append "loop=1" }}
{{- end }}
{{- if $start }}
    {{ $queryParams = $queryParams | append (printf "start=%d" $start) }}
{{- end }}

{{- if gt (len $queryParams) 0 }}
    {{- $youtubeURL = printf "%s?%s" $youtubeURL (delimit $queryParams "&") }}
{{- end }}
{{/* --- END MODIFIED LOGIC --- */}}

<div class="force-16-9-ratio youtube-video-center {{ with $class }} {{ . }}{{ end }}">
  {{- if $cdn }}
  <lite-youtube videoid="{{ $id }}" playlabel="{{ $title }}"></lite-youtube>
  {{- else }}
  <iframe src="{{ $youtubeURL }}"
    title="{{ $title }}"
    frameborder="0"
    allow="accelerometer; {{ if $autoplay }}autoplay;{{ end }} clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    {{ if not $allowFullScreen }}allowfullscreen="false"{{ else }}allowfullscreen="true"{{ end }}
    loading="{{ $loading }}">
  </iframe>
  {{- end }}
</div>
