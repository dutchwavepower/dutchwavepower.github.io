{{- /*
Renders an embedded YouTube video with extended size and alignment control.

@param {bool} [allowFullScreen=true] Whether the iframe element can activate full screen mode.
@param {bool} [autoplay=false] Whether to automatically play the video. Forces mute to be true.
@param {string} [class] The class attribute of the wrapping div element. When specified, removes the style attributes from the iframe element and its wrapping div element.
@param {bool} [controls=true] Whether to display the video controls.
@param {int} [end] The time, measured in seconds from the start of the video, when the player should stop playing the video.
@param {string} [id] The video id. Optional if the id is the first and only positional argument.
@param {string} [loading=eager] The loading attribute of the iframe element.
@param {bool} [loop=false] Whether to indefinitely repeat the video. Ignores the start and end arguments after the first play.
@param {bool} [mute=false] Whether to mute the video. Always true when autoplay is true.
@param {int} [start] The time, measured in seconds from the start of the video, when the player should start playing the video.
@param {string} [title] The title attribute of the iframe element. Defaults to "YouTube video".
@param {string} [width] The width of the video. E.g., "560", "100%".
@param {string} [height] The height of the video. E.g., "315", "auto".
@param {string} [align] The alignment of the video: "left", "center", "right".

@returns {template.HTML}

@reference https://developers.google.com/youtube/player_parameters

@example {{< youtube 0RKpf3rK57I >}}
@example {{< youtube id=0RKpf3rK57I loading=lazy start=30 >}}
@example {{< youtube id="0RKpf3rK57I" width="800" height="450" align="center" >}}
@example {{< youtube id="0RKpf3rK57I" width="100%" align="left" >}}
*/}}

{{- $pc := .Page.Site.Config.Privacy.YouTube }}
{{- $remoteErrID := "err-youtube-remote" }}
{{- $referrerpolicy := "strict-origin-when-cross-origin" }} {{/* Moved this definition here */}}

{{- if not $pc.Disable }}
  {{- with $id := or (.Get "id") (.Get 0) }}

    {{- /* Set defaults. */}}
    {{- $allowFullScreen := true }}
    {{- $autoplay := 0 }}
    {{- $class := "" }}
    {{- $controls := 1 }}
    {{- $end := 0 }}
    {{- $loading := "eager" }}
    {{- $loop := 0 }}
    {{- $mute := 0 }}
    {{- $start := 0 }}
    {{- $title := "YouTube video" }}
    {{- $iframeAllowList := "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" }}
    {{- $width := "" }}
    {{- $height := "" }}
    {{- $align := "" }}

    {{- /* Get arguments. */}}
    {{- if in (slice "true" true 1) ($.Get "allowFullScreen") }}
      {{- $allowFullScreen = true }}
    {{- else if in (slice "false" false 0) ($.Get "allowFullScreen") }}
      {{- $allowFullScreen = false }}
    {{- end }}
    {{- if in (slice "true" true 1) ($.Get "autoplay") }}
      {{- $autoplay = 1 }}
    {{- else if in (slice "false" false 0) ($.Get "autoplay") }}
      {{- $autoplay = 0 }}
    {{- end }}
    {{- if in (slice "true" true 1) ($.Get "controls") }}
      {{- $controls = 1 }}
    {{- else if in (slice "false" false 0) ($.Get "controls") }}
      {{- $controls = 0 }}
    {{- end }}
    {{- if in (slice "true" true 1) ($.Get "loop") }}
      {{- $loop = 1 }}
    {{- else if in (slice "false" false 0) ($.Get "loop") }}
      {{- $loop = 0 }}
    {{- end }}
    {{- if or (in (slice "true" true 1) ($.Get "mute")) $autoplay }}
      {{- $mute = 1 }}
    {{- else if in (slice "false" false 0) ($.Get "mute") }}
      {{- $mute = 0 }}
    {{- end }}
    {{- $class = or ($.Get "class") $class }}
    {{- $end = or ($.Get "end") $end }}
    {{- $loading = or ($.Get "loading") $loading }}
    {{- $start = or ($.Get "start") $start }}
    {{- $title = or ($.Get "title") $title }}
    {{- $width = or ($.Get "width") $width }}
    {{- $height = or ($.Get "height") $height }}
    {{- $align = or ($.Get "align") $align }}


    {{- /* Adjust iframeAllowList. */}}
    {{- if $allowFullScreen }}
      {{- $iframeAllowList = printf "%s; fullscreen" $iframeAllowList }}
    {{- end }}

    {{- /* Define src attribute - Manual Query Params. */}}
    {{- $host := cond $pc.PrivacyEnhanced "www.youtube-nocookie.com" "www.youtube.com" }}
    {{- $src := printf "https://%s/embed/%s" $host $id }}

    {{- $queryParams := slice }}

    {{- if eq $autoplay 1 }}
        {{ $queryParams = $queryParams | append "autoplay=1" }}
        {{ $queryParams = $queryParams | append "mute=1" }} {{/* Autoplay implies mute */}}
    {{- else if eq $mute 1 }}
        {{ $queryParams = $queryParams | append "mute=1" }}
    {{- end }}

    {{- if eq $controls 0 }}
        {{ $queryParams = $queryParams | append "controls=0" }}
    {{- end }}

    {{- if gt $end 0 }}
        {{ $queryParams = $queryParams | append (printf "end=%d" $end) }}
    {{- end }}

    {{- if eq $loop 1 }}
        {{ $queryParams = $queryParams | append "loop=1" }}
        {{ $queryParams = $queryParams | append (printf "playlist=%s" $id) }} {{/* Loop requires playlist ID */}}
    {{- end }}

    {{- if gt $start 0 }}
        {{ $queryParams = $queryParams | append (printf "start=%d" $start) }}
    {{- end }}

    {{- if gt (len $queryParams) 0 }}
        {{- $src = printf "%s?%s" $src (delimit $queryParams "&") }}
    {{- end }}

    {{- /* Build custom inline styles for div and iframe based on new parameters */}}
    {{- $divExtraStyle := "" }}
    {{- $iframeExtraStyle := "" }}
    {{- $wrapperClasses := slice }}

    {{- if $width }}
        {{- $divExtraStyle = printf "width: %s;" $width }}
        {{- $iframeExtraStyle = printf "width: %s; height: %s;" $width (default "auto" $height) }}
        {{- if not $height }}
            {{- /* If only width is set, calculate responsive height for 16:9 aspect ratio */}}
            {{- $divExtraStyle = printf "%s position: relative; padding-bottom: calc(%s * 0.5625);" $divExtraStyle $width }}
            {{- $iframeExtraStyle = printf "%s position: absolute; top: 0; left: 0;" $iframeExtraStyle }}
        {{- end }}
    {{- end }}

    {{- if $height }}
        {{- $iframeExtraStyle = printf "%s height: %s;" $iframeExtraStyle $height }}
    {{- end }}


    {{- /* Set text alignment for the wrapper based on 'align' parameter */}}
    {{- if eq $align "left" }}
        {{- $wrapperClasses = $wrapperClasses | append "align-left" }}
    {{- else if eq $align "right" }}
        {{- $wrapperClasses = $wrapperClasses | append "align-right" }}
    {{- else if eq $align "center" }}
        {{- $wrapperClasses = $wrapperClasses | append "align-center" }}
    {{- else }}
        {{- /* Default if align parameter is not specified or invalid */}}
        {{- $wrapperClasses = $wrapperClasses | append "force-16-9-ratio" }} {{/* Keep original if no custom alignment */}}
    {{- end }}

    {{- if $class }}
        {{- $wrapperClasses = $wrapperClasses | append $class }}
        {{- $divExtraStyle = "" }} {{/* If custom class is provided, it's assumed to handle styling */}}
        {{- $iframeExtraStyle = "" }}
    {{- end }}

    {{- $finalWrapperClasses := delimit $wrapperClasses " " }}


    {{- /* Render. */ -}}
    <div
      {{- with $finalWrapperClasses }} class="{{ . }}" {{- end }}
      {{- if $divExtraStyle }} style="{{ $divExtraStyle | safeCSS }}" {{- end -}}
    >
      <iframe
        {{- with $iframeAllowList }} allow="{{ . }}" {{- end }}
        {{- with $loading }} loading="{{ . }}" {{- end }}
        {{- with $referrerpolicy }} referrerpolicy="{{ . }}" {{- end }}
        {{- with $src }} src="{{ . }}" {{- end }}
        {{- if $iframeExtraStyle }} style="{{ $iframeExtraStyle | safeCSS }}" {{- end }}
        {{- with $title }} title="{{ . }}" {{- end -}}
      ></iframe>
    </div>
  {{- else }}
    {{- errorf "The %q shortcode requires an id argument. See %s" .Name .Position }}
  {{- end }}
{{- end }}
